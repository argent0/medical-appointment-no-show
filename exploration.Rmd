# Exploring No Show data

The objective of this exploration is to present the main characteristics of
data set visually.

```{r setup, results="hide"}
require("dplyr")
require("functional")
require("knitr")
```

## Loading the data

```{r load_data, cache=TRUE}
appData <-
	read.csv(
		 unz("data/noshowappointments.zip", "KaggleV2-May-2016.csv"),
		 header=TRUE)
```

## Description of Variables

```{r structure}
str(appData)
```

Some variables that might require a short explanation:

* **ScheduledDay**: The day the appointment was made.
* **AppointmentDay**: The day of the appointment.
* **Neighbourhood**: The Neighbourhood where the clinic is located.
* **Scholarship**: 1 if the person receives
  [aid from the government](https://en.wikipedia.org/wiki/Bolsa_Fam%C3%ADlia).
* **Handcap**: According to the source, A number that represents the person's
  disabilities.
* **SMS_received**: Whether the people received an SMS reminding them of the
  appointment. 
* **No.show**: "Yes", means that the person missed the appointment. "No", that
  the person went to the appointment.

## Computing new variables

**Wait**: the number of days from the scheduling date to the appointment date.

```{r compute_wait, cache=TRUE}
schedDay <- const (
	sapply(X = (appData$ScheduledDay %>% as.character %>% strsplit("T")),
	       FUN=`[[`, 1) %>%
	strptime("%Y-%m-%d") %>% as.Date)


appDay <- const (
	sapply(X = (appData$AppointmentDay %>% as.character %>% strsplit("T")),
	       FUN=`[[`, 1) %>%
	strptime("%Y-%m-%d") %>% as.Date)

appData$Wait= (appDay() - schedDay()) %>% as.numeric #in days
appData$ScheduledDay = schedDay()
appData$AppointmentDay = appDay()
```

## Cleaning the data

**Removing rows where appoitment time is before scheduled time**

Some appointments have dates are before the scheduling date.

```{r remove_negative_wait}
appData <- appData[appData$Wait>=0,]
```

**Remove the register with Age < 0**

```{r}
print(appData[appData$Age < 0,])
appData <- appData[appData$Age>=0,]
```

## Data composition

**Distribution of genders**
```{r gender_distribution, fig.height=10}
par(mfrow=c(2,1))
tbl_gender <- table(appData$No.show, appData$Gender) 
barplot(tbl_gender, xlab="Gender", ylab="count", col=c(2,4))
title(main="Most patients are female.")
legend("topright", title="No.show", fill=c(2,4),
       legend=levels(appData$No.show), cex=0.7)
tbl_gender %>% prop.table(2) %>% 
	barplot(xlab="Gender", ylab="Proportion", col=c(2,4))
title("Both genders are equally likely to miss the appointment")
```

**Distribution of ages**

```{r hist_ages_1, fig.show="hide"}
hist_age<-hist(appData$Age)
```
```{r hist_ages_2, fig.height=10}
par(mfrow=c(2,1))
barplot(table(appData$No.show, cut(appData$Age, hist_age$breaks,
	include.lowest=TRUE)), xlab="Age Bracket", ylab="count", col=c(2,4))
title("Histogram of Age")
legend("topright", title="No.show", fill=c(2,4), legend=levels(appData$No.show))
barplot(table(appData$No.show, cut(appData$Age, hist_age$breaks)) %>% prop.table(2),
	xlab="Age Bracket", ylab="Proportion", col=c(2,4))
```

**Distribution of waiting time**
```{r hist_wait, fig.show="hide"}
hist_wait <-hist(appData$Wait)
```

```{r hist_wait_2, fig.height=10}
par(mfrow=c(2,1))
tbl_wait <- table(appData$No.show, cut(appData$Wait, hist_wait$breaks,
				       include.lowest=TRUE))
barplot(tbl_wait, xlab="Wait Bracket", ylab="count", col=c(2,4))
legend("topright", title="No.show", fill=c(2,4),
       legend=levels(appData$No.show))
title("Histogram of Wait")
barplot(tbl_wait %>% prop.table(2), xlab="Wait",
			 ylab="Proportion of No.show", col=c(2,4))
title(main="Lower wait times have better turn up.")
```

**Distribution of Neighbourhoods**

```{r hist_neighbourhood, fig.height=10, cache=TRUE}
tbl_neigh <- table(appData$No.show, appData$Neighbourhood)
par(mfrow=c(2,1))
barplot(tbl_neigh, col=c(2,4),
	ylab="Count", xlab="Neighbourhood")
legend("topleft", title="No.show", fill=c(2,4),
       legend=levels(appData$No.show), cex=0.7, xpd=TRUE)
barplot(tbl_neigh %>% prop.table(2), col=c(2,4),
	ylab="Proportion", xlab="Neighbourhood")
title(main="Most location have the same turn up ratio")
```

**Distribution of other categorical variables**

```{r hists_categorical_variables, results="hide", fig.height=20}
par(oma = c(0,0,2,0))
hs <- c(0.75,rep(1,6))
hs <- hs / sum(hs)
layout(matrix(c(1,1,seq(2,13)),nrow = 7,ncol = 2,byrow = TRUE)
       ,heights = hs)
plot(1, type = "n", axes=FALSE, xlab="", ylab="")
legend("bottom", inset=0, title="No.show",
       pch=c(15,15,21), col=c(2,4),
       legend=c("No", "Yes"),
       , horiz=TRUE)
title(main="Histogram/Composition", sub="Maybe SMS = 1 means no SMS was sent.")

mapply(FUN=function(column,varname) {
	tbl_var <- table(appData$No.show, column)
	barplot(tbl_var, xlab=varname, ylab="Count", col=c(2,4))
	barplot(prop.table(tbl_var,2), xlab=varname,
				 ylab="Proportion", col=c(2,4))
},appData[,8:13], names(appData)[8:13])


```


The last row of plots suggests that when `SMS_received == 0` the patient is more
likely to show up. **Thus the `0` might mean that SMS was received**.

## Some Characteristics
**Some patients have more than one appointment per day**
```{r multiple_appointments}
ordAppData <- appData[order(appData$AppointmentDay),]
ordAppData %>% group_by(PatientId, AppointmentDay) %>%
	summarize(C=n()) %>% ungroup() %>% select(C) %>% `[[`(1) %>%
	table(dnn="Appointments per day")
```

## Relation of variables to No.show

**Did the patient showed up for its previous appointment**

```{r previous_appointment, cache=TRUE}
last_outcome <- ordAppData %>% group_by(PatientId, AppointmentDay) %>%
	summarize(nYes=sum(No.show == "Yes"), nNo=sum(No.show == "No")) %>% ungroup %>%
	group_by(PatientId) %>%
	mutate(pnYes=lag(nYes), pnNo=lag(nNo)) %>% ungroup

ordAppDataWithLastOutcome <- inner_join(ordAppData, last_outcome, by= c("PatientId","AppointmentDay"))

nextVsPrev <- const %$% table(ordAppDataWithLastOutcome$No.show,
			      ordAppDataWithLastOutcome$pnYes > 0, useNA="ifany")
par(mfrow=c(1,2), oma = c(0, 0, 2, 0))
nextVsPrev() %>%
	barplot(xlab="Previos No.show", ylab="count",
		names.arg=c("No", "Yes", "NA"), col=c("red","blue"))
legend(x=0.5,y=60000, title="No.show", fill=c("red","blue"),
       legend=levels(appData$No.show))
nextVsPrev() %>% prop.table(2) %>%
	barplot(xlab="Previos No.show", ylab="Proportion",
		names.arg=c("No", "Yes", "NA"), col=c("red","blue"))
mtext("Next No.show vs previous No.show.", outer = TRUE, cex = 1.5)
```

Patients that missed their previous appointment are more likely to miss the next
one.

**[EXTRA]Gender by age**
```{r age_by_gender, results="hide", fig.height=10 }
par(mfrow=c(2,1))
table(appData$Gender, cut(appData$Age, hist_age$breaks , include.lowest=TRUE)) %>%
	barplot(xlab="Age Bracket", ylab="Count", col=c(2,4))
legend("topright", title="Legend",
       pch=c(15,15), col=c(2,4),
       legend=c("Female", "Male")) 
table(appData$Gender, cut(appData$Age, hist_age$breaks,
			  include.lowest=TRUE)) %>%
	prop.table(2) %>% barplot(xlab="Age Bracket", ylab="Proportion", col=c(2,4))
title(main="Women are the majority after the age of 16.")
```

Big increase in the proportion of women after 16 years.
